# Claude Token Monitor

A GNOME Shell extension that displays your **Claude AI token usage** directly
in the top panel as two compact progress bars – one for the 5-hour session
window and one for the weekly quota.

```
[icon] 5h ████████░░░░░░░ 48k / 200k
        7d ██░░░░░░░░░░░░░ 1.2M / 10M
```

The bars turn **orange at 80 %** and **bright red at 100 %** (or above, since
brief overages are possible).

---

## Requirements

| Requirement | Version |
|---|---|
| GNOME Shell | 45, 46, 47, or 48 |
| `glib-compile-schemas` | any (from `glib2` / `libglib2.0-bin`) |

---

## Installation

### Via `make` (recommended)

```bash
# 1. Clone
git clone https://github.com/maki/claude-tokens-gnome.git
cd claude-tokens-gnome

# 2. Compile schema + install
make install

# 3. Restart GNOME Shell
#    X11:    press Alt+F2, type r, press Enter
#    Wayland: log out and back in

# 4. Enable the extension
make enable
# or: gnome-extensions enable claude-tokens@maki
# or: via GNOME Extensions app
```

### Manual install

```bash
UUID=claude-tokens@maki
DEST="$HOME/.local/share/gnome-shell/extensions/$UUID"
mkdir -p "$DEST/schemas"
cp metadata.json extension.js prefs.js stylesheet.css "$DEST/"
cp schemas/org.gnome.shell.extensions.claude-tokens.gschema.xml "$DEST/schemas/"
glib-compile-schemas "$DEST/schemas/"
```

Then restart GNOME Shell and enable the extension.

---

## Setup – getting your session cookie

The extension talks to the claude.ai **web API** using your browser session.
No API key is needed.

1. Open [https://claude.ai](https://claude.ai) and log in.
2. Open your browser's DevTools (**F12** or Ctrl+Shift+I).
3. Go to **Application** (Chrome/Edge) or **Storage** (Firefox) →
   **Cookies** → `https://claude.ai`.
4. Find the cookie named `sessionKey`.
5. Copy its **value** (starts with `sk-ant-sid01-…`).
6. Open the extension preferences:
   - Click the icon in the top panel → **Settings…**, or
   - Run `gnome-extensions prefs claude-tokens@maki`.
7. Paste the value into the **Session cookie** field.
8. Click **Test** to verify, then close the dialog.

The extension will immediately start polling and the bars will populate in
the panel.

> **Privacy note:** The session cookie is stored in your GNOME keyring-backed
> GSettings database (`~/.local/share/gnome-shell/…`). It is never sent
> anywhere except the official `claude.ai` domain.

---

## How it works

| Metric | Source |
|---|---|
| Session (5-hour window) | `GET https://claude.ai/api/organizations/{id}/rate_limit_status` |
| Weekly quota | same endpoint, different entry |

The extension resolves your organisation ID once at startup via
`GET https://claude.ai/api/auth/current_account`, then polls the rate-limit
endpoint on an adaptive schedule:

- **30 s** when usage has not changed since the last poll  
- **5 s** when tokens are actively being consumed  

Both intervals are configurable in the Preferences dialog.

---

## Building a distributable zip

```bash
make pack
# → claude-tokens@maki.zip  (ready for extensions.gnome.org upload)
```

---

## Project layout

```
claude-tokens-gnome/
├── metadata.json          # Extension manifest
├── extension.js           # Main logic & panel indicator (GNOME 45+, ES modules)
├── prefs.js               # Adw preferences window
├── stylesheet.css         # Panel widget styling
├── schemas/
│   ├── org.gnome.shell.extensions.claude-tokens.gschema.xml
│   └── gschemas.compiled  (generated by make / glib-compile-schemas)
├── Makefile
└── README.md
```

---

## Troubleshooting

| Symptom | Fix |
|---|---|
| Bars show "No session cookie configured" | Open Settings and paste your `sessionKey` value |
| "Authentication failed" | Your session has expired – re-copy the cookie from the browser |
| Bars are empty after setting the cookie | Click the panel icon → **Refresh now**, or wait ~5 s |
| `make install` fails on `glib-compile-schemas` | Install `libglib2.0-bin` (Debian/Ubuntu) or `glib2` (Arch/Fedora) |
| Extension does not appear after restart | Run `journalctl /usr/bin/gnome-shell -f` and look for JS errors |

---

## Contributing

Bug reports and pull requests are welcome on GitHub.

---

## License

MIT
